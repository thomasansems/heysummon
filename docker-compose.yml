# Volume backup instructions:
#   # Create a backup of the SQLite database:
#   docker run --rm -v heysummon_appdata:/data -v $(pwd):/backup alpine \
#     cp /data/heysummon.db /backup/heysummon-backup-$(date +%Y%m%d).db
#
#   # Restore from backup:
#   docker run --rm -v heysummon_appdata:/data -v $(pwd):/backup alpine \
#     cp /backup/heysummon-backup.db /data/heysummon.db

services:
  mercure:
    image: dunglas/mercure
    restart: unless-stopped
    environment:
      SERVER_NAME: ':3000'
      MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_JWT_SECRET:?Set MERCURE_JWT_SECRET}
      MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_JWT_SECRET}
      MERCURE_EXTRA_DIRECTIVES: |
        cors_origins ${MERCURE_CORS_ORIGINS:-https://cloud.heysummon.ai}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
    # No ports exposed â€” only accessible via internal network
    # Anonymous subscribers DISABLED by default (no MERCURE_EXTRA_DIRECTIVES: anonymous)

  app:
    build: .
    restart: unless-stopped
    ports:
      - "${APP_PORT:-3000}:3000"
    depends_on:
      mercure:
        condition: service_healthy
    volumes:
      - appdata:/app/data
    environment:
      DATABASE_URL: file:/app/data/heysummon.db
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?Set NEXTAUTH_SECRET}
      AUTH_GITHUB_ID: ${AUTH_GITHUB_ID:-}
      AUTH_GITHUB_SECRET: ${AUTH_GITHUB_SECRET:-}
      MERCURE_HUB_URL: http://mercure:3000/.well-known/mercure
      MERCURE_JWT_SECRET: ${MERCURE_JWT_SECRET}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  appdata:
