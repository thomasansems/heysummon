services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: heysummon
      POSTGRES_PASSWORD: ${DB_PASSWORD:-heysummon_dev}
      POSTGRES_DB: heysummon
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U heysummon"]
      interval: 5s
      timeout: 3s
      retries: 5
    # No ports exposed — only accessible via internal network

  mercure:
    image: dunglas/mercure
    restart: unless-stopped
    environment:
      SERVER_NAME: ':3000'
      MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_JWT_SECRET:?Set MERCURE_JWT_SECRET}
      MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_JWT_SECRET}
      MERCURE_EXTRA_DIRECTIVES: |
        cors_origins ${MERCURE_CORS_ORIGINS:-https://cloud.heysummon.ai}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
    # No ports exposed — only accessible via internal network
    # Anonymous subscribers DISABLED by default (no MERCURE_EXTRA_DIRECTIVES: anonymous)

  heysummon-guard:
    build: ./guard
    restart: unless-stopped
    read_only: true
    cap_drop: [ALL]
    security_opt:
      - no-new-privileges:true
    environment:
      GUARD_HMAC_SECRET: ${GUARD_HMAC_SECRET:-}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3457/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    # NO external ports — internal only

  app:
    build: .
    restart: unless-stopped
    ports:
      - "${APP_PORT:-3000}:3000"
    depends_on:
      db:
        condition: service_healthy
      mercure:
        condition: service_healthy
      heysummon-guard:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://heysummon:${DB_PASSWORD:-heysummon_dev}@db:5432/heysummon
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?Set NEXTAUTH_SECRET}
      AUTH_GITHUB_ID: ${AUTH_GITHUB_ID:-}
      AUTH_GITHUB_SECRET: ${AUTH_GITHUB_SECRET:-}
      MERCURE_HUB_URL: http://mercure:3000/.well-known/mercure
      MERCURE_JWT_SECRET: ${MERCURE_JWT_SECRET}
      GUARD_URL: http://heysummon-guard:3457
      GUARD_HMAC_SECRET: ${GUARD_HMAC_SECRET:-}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  pgdata:
