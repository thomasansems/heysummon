services:
  # ── Key Generation (runs once on first startup) ──
  guard-keygen:
    build: ./guard
    user: "0:0"
    entrypoint: ["sh", "-c", "
      if [ ! -f /keys/.guard-keys-generated ]; then
        node -e \"
          const nacl = require('tweetnacl');
          const kp = nacl.sign.keyPair();
          const priv = Buffer.from(kp.secretKey).toString('hex');
          const pub = Buffer.from(kp.publicKey).toString('hex');
          require('fs').writeFileSync('/keys/guard-signing-key', priv);
          require('fs').writeFileSync('/keys/guard-public-key', pub);
          require('fs').writeFileSync('/keys/.guard-keys-generated', 'done');
          console.log('Guard Ed25519 keys generated.');
        \";
      else
        echo 'Guard keys already exist, skipping generation.';
      fi
    "]
    volumes:
      - guard-keys:/keys

  db-migrate:
    build:
      context: .
      target: deps
    entrypoint: ["sh", "-c", "npx prisma db push --skip-generate --accept-data-loss"]
    environment:
      DATABASE_URL: postgresql://heysummon:${DB_PASSWORD:-heysummon_dev}@db:5432/heysummon
    networks:
      - backend
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:16-alpine
    restart: unless-stopped
    networks:
      - backend
    environment:
      POSTGRES_USER: heysummon
      POSTGRES_PASSWORD: ${DB_PASSWORD:-heysummon_dev}
      POSTGRES_DB: heysummon
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U heysummon"]
      interval: 5s
      timeout: 3s
      retries: 5

  mercure:
    image: dunglas/mercure
    restart: unless-stopped
    networks:
      - backend
    environment:
      SERVER_NAME: ':3446'
      MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_JWT_SECRET:?Set MERCURE_JWT_SECRET}
      MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_JWT_SECRET}
      MERCURE_EXTRA_DIRECTIVES: |
        cors_origins ${MERCURE_CORS_ORIGINS:-https://cloud.heysummon.ai}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3446/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Guard: Single entry point (reverse proxy) ──
  # All external traffic goes through Guard first.
  heysummon-guard:
    build: ./guard
    restart: unless-stopped
    read_only: true
    cap_drop: [ALL]
    security_opt:
      - no-new-privileges:true
    ports:
      - "${GUARD_PORT:-3445}:3000"
    networks:
      - frontend
      - backend
    depends_on:
      guard-keygen:
        condition: service_completed_successfully
      app:
        condition: service_healthy
    environment:
      PORT: "3000"
      PLATFORM_URL: http://app:3000
      GUARD_SIGNING_KEY_FILE: /keys/guard-signing-key
    entrypoint: ["sh", "-c", "
      export GUARD_SIGNING_KEY=$$(cat /keys/guard-signing-key);
      exec node dist/index.js
    "]
    volumes:
      - guard-keys:/keys:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Platform: Internal only (no exposed ports) ──
  app:
    build: .
    restart: unless-stopped
    # NO external ports — only reachable via Guard on the backend network
    networks:
      - backend
    depends_on:
      guard-keygen:
        condition: service_completed_successfully
      db-migrate:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      mercure:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://heysummon:${DB_PASSWORD:-heysummon_dev}@db:5432/heysummon
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3445}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?Set NEXTAUTH_SECRET}
      AUTH_TRUST_HOST: "true"
      AUTH_GITHUB_ID: ${AUTH_GITHUB_ID:-}
      AUTH_GITHUB_SECRET: ${AUTH_GITHUB_SECRET:-}
      MERCURE_HUB_URL: http://mercure:3446/.well-known/mercure
      MERCURE_JWT_SECRET: ${MERCURE_JWT_SECRET}
      GUARD_PUBLIC_KEY_FILE: /keys/guard-public-key
      REQUIRE_GUARD: "true"
      HEYSUMMON_PUBLIC_URL: ${HEYSUMMON_PUBLIC_URL:-}
    entrypoint: ["sh", "-c", "
      export GUARD_PUBLIC_KEY=$$(cat /keys/guard-public-key);
      exec node server.js
    "]
    volumes:
      - guard-keys:/keys:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ── Tunnel Services (activate with --profile) ──

  # Cloudflare Tunnel: docker compose --profile cloudflare up -d
  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    profiles: ["cloudflare"]
    command: tunnel --no-autoupdate run
    networks:
      - frontend
    depends_on:
      heysummon-guard:
        condition: service_healthy
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN:-}
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Tailscale Funnel: docker compose --profile tailscale up -d
  tailscale:
    image: tailscale/tailscale:latest
    restart: unless-stopped
    profiles: ["tailscale"]
    hostname: heysummon
    networks:
      - frontend
    depends_on:
      heysummon-guard:
        condition: service_healthy
    environment:
      TS_AUTHKEY: ${TAILSCALE_AUTHKEY:-}
      TS_STATE_DIR: /var/lib/tailscale
      TS_EXTRA_ARGS: --advertise-tags=tag:heysummon
      TS_SERVE_CONFIG: /config/serve.json
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./tailscale-config:/config:ro
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    healthcheck:
      test: ["CMD", "tailscale", "status", "--json"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Ngrok: docker compose --profile ngrok up -d
  ngrok:
    image: ngrok/ngrok:latest
    restart: unless-stopped
    profiles: ["ngrok"]
    command: http heysummon-guard:3000 --log stdout ${NGROK_DOMAIN:+--domain=${NGROK_DOMAIN}}
    networks:
      - frontend
    depends_on:
      heysummon-guard:
        condition: service_healthy
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:-}
    ports:
      - "4040:4040"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4040/status"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Prisma Studio: docker compose --profile debug up -d
  prisma-studio:
    build:
      context: .
      target: deps
    restart: unless-stopped
    profiles: ["debug"]
    entrypoint: ["sh", "-c", "npx prisma studio --port 3447 --browser none"]
    ports:
      - "${PRISMA_STUDIO_PORT:-3447}:5555"
    networks:
      - backend
    environment:
      DATABASE_URL: postgresql://heysummon:${DB_PASSWORD:-heysummon_dev}@db:5432/heysummon
    depends_on:
      db:
        condition: service_healthy

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true  # No external access — Platform is isolated

volumes:
  pgdata:
  guard-keys:
  heysummon-data:
  tailscale-state:
